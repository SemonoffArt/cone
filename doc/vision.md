# Technical Vision - Cone App

## 1. ТЕХНОЛОГИИ

### Стек технологий

**Язык и фреймворк:**
- Python 3.13+ - основной язык проекта
- Tkinter - встроённый GUI фреймворк (минимальные зависимости)

**Библиотеки:**
- **Pillow (>=12.0.0)** - обработка и манипуляция изображениями
- **Requests (>=2.32.5)** - HTTP клиент для интеграции с Trassir


**Управление зависимостями:**
- `uv` - быстрый и надёжный менеджер зависимостей (рекомендуется)


### Поддерживаемые платформы
- Windows


### Функционал загрузки изображений
- ✅ Локальные файлы (PNG, JPG, BMP и т.д.)
- ✅ Видеопоток с камер Trassir по IP (для полного функционала)

---

## 4. АРХИТЕКТУРА ПРОЕКТА

### Основной принцип: Simple & Direct

Никакого оверэнжиниринга. Прямые вызовы функций, прямое обновление UI.

### Ток данных

```
Пользователь действует
         ↓
   canvas_view.py (обработка мыши)
         ↓
   main_window.py (контроллер)
         ↓
   core/* (расчёты)
         ↓
   Новые данные
         ↓
   info_panel.py (отображение результатов)
```

### Взаимодействие компонентов

**main_window.py (контроллер - тюленя)**
- Нициализирует все компоненты UI (canvas, toolbar, menu, info_panel)
- Главное окно Tkinter
- Не содержит логику рисования (ona v canvas_view.py)

**canvas_view.py (отдельный Canvas)**
- Tkinter Canvas для рисования изображения и треугольника
- Обработка мыши (клики, драг, приближение)
- Высылает события в main_window (нажата кнопка, нарисован треугольник)
- Ответ за визуализацию данных

**core/* (бизнес-логика)**
- Stateless функции для расчётов
- `cone_calculator.py` - формула V = ⅓πR²h
- `geometry.py` - высота, радиус, расстояния
- `triangle.py` - работа с точками треугольника
- `image_loader.py` - чтение файлов изображений
- Не знают о пользователе, canvas, UI

**info_panel.py (отображение)**
- Панель для отображения результатов (объём, высота, радиус)
- main_window передает данные: `info_panel.update_results(volume, height, radius)`

**toolbar.py, menu.py**
- main_window есть каллбэки на кнопки и меню
- Они стройтся и высылают события в main_window


### Ключевые свойства архитектуры

✅ **Stateless core**
- Каждый вызов функции core возвращает результат
- Ниет никакого глобального состояния

✅ **Состояние в main_window**
- main_window хранит текущее выделение: треугольник, изображение, масстаб
- Это не основное состояние, а рабочие данные

✅ **Прямые вызовы**
- main_window напрямую вызывает core данные данных и обновляет UI
- Никакого callback hell, observer patterns, signals/slots

✅ **Зависимости вятъя с передачей**
- ui компоненты рецензия ссылку на main_window (для callback)
- core модули вызываются без сохранения ссылок

### Обработка ошибок

**Простая трёхуровка:**
```python
try:
    image = image_loader.load_image(path)
    self.canvas_view.set_image(image)
except Exception as e:
    logger.error(f"Failed to load image: {e}")
    messagebox.showerror("Error", f"Cannot load image: {e}")
```

**Все ошибки логируются в logger.py**
- Централизованное логирование
- Удобно для дебага

---

## 5. МОДЕЛЬ ДАННЫХ

### Принцип: Минимализм

Нет сложных структур, нет ORM, нет БД. Только то, что нужно для работы в памяти.

### Основные структуры данных

### Жизненный цикл данных

```
1. Пользователь открывает изображение
   ↓
   image_loader.load_image(path) → PIL.Image
   ↓
   main_window.current_image = image

2. Пользователь рисует треугольник
   ↓
   triangle.add_point(x, y) → (повторить 3 раза)
   ↓
   triangle.points = [(x1,y1), (x2,y2), (x3,y3)]

3. Рассчитать объём
   ↓
   height_px = triangle.get_height()
   radius_px = triangle.get_base_width() / 2
   ↓
   result = cone_calculator.calculate(
       height_px=height_px,
       base_width_px=triangle.get_base_width(),
       pixel_size_m=main_window.pixel_size_m
   )
   ↓
   result = CalculationResult(volume=..., height=..., radius=...)

4. Отобразить результат
   ↓
   info_panel.update_results(result)
   canvas_view.redraw(triangle)
```

### Отсутствие в MVP

❌ **История измерений**
- Данные живут только в памяти текущего сеанса
- При закрытии приложения всё теряется
- Сохранение можно добавить на этапе 2

❌ **Персистентность**
- Нет конфигурационных файлов
- Нет JSON/CSV сохранения
- Все параметры в constants.py

❌ **Сложные структуры**
- Нет классов Point, Vertex, Line
- Используем простые tuple для координат
- Нет наследования и полиморфизма

✅ **Что есть**
- Простые классы для Triangle и результатов
- Встроенные типы: list, tuple, float
- dataclass для упорядочивания результатов

### Граница между слоями по данным

**core/** работает с:
- Пиксельные координаты (int/float)
- Размеры в пикселях
- Метрические единицы (высота, радиус, объём в метрах)

**ui/** работает с:
- Координаты в Canvas (пиксели на экране)
- PIL.Image для отображения
- CalculationResult для показа результатов

**Конвертация:**
```python
# В main_window.py
def recalculate():
    # Получить пиксельные данные из Triangle
    height_px = self.triangle.get_height()
    base_px = self.triangle.get_base_width()
    
    # Вызвать core с пиксельными координатами
    result = cone_calculator.calculate(
        height_px=height_px,
        base_width_px=base_px,
        pixel_size_m=self.pixel_size_m
    )
    
    # result уже в метрических единицах
    # Отобразить в UI
    self.info_panel.update_results(result)
```

---

## 6. СЦЕНАРИИ РАБОТЫ (USE CASES)

### Основные сценарии MVP

**Сценарий 1: Открыть изображение**
```
Пользователь → File → Open Image
                ↓
           Диалог выбора файла
                ↓
           image_loader.load_image(path)
                ↓
           canvas_view.display_image(image)
                ↓
           Изображение видно на экране
```
- Поддерживаемые форматы: PNG, JPG, BMP, GIF и т.д. (Pillow)
- Изображение масштабируется на весь canvas
- Треугольник очищается (новое измерение)

**Сценарий 2: Нарисовать треугольник**
```
Пользователь → Клик на canvas (3 раза)
                ↓
           canvas_view.on_click(x, y)
                ↓
           triangle.add_point(x, y)
                ↓
           if triangle.is_complete():
               recalculate()
                ↓
           Треугольник видно на экране, результаты показаны
```
- Каждый клик добавляет вершину
- После 3-й вершины автоматически пересчитывается объём
- Визуальная обратная связь: точки отмечены, линии нарисованы

**Сценарий 3: Пересчитать объём**
```
Триангл изменён
                ↓
           main_window.recalculate()
                ↓
           core.cone_calculator.calculate(...)
                ↓
           result = CalculationResult(volume, height, radius)
                ↓
           info_panel.update_results(result)
                ↓
           canvas_view.redraw(triangle)
                ↓
           Новые значения видны в info_panel
```
- Происходит автоматически при изменении треугольника
- Результаты обновляются в реальном времени
- Никаких задержек, только вычисления

**Сценарий 4: Изменить масштаб (Zoom)**
```
Пользователь → Кнопка + (увеличить) или - (уменьшить)
                ↓
           pixel_size_m *= 1.1  (для +)
           pixel_size_m /= 1.1  (для -)
                ↓
           main_window.recalculate()
                ↓
           Объём пересчитывается с новым масштабом
                ↓
           info_panel показывает новые значения
```
- Горячие клавиши: `+` и `-` (из user_preference)
- Кнопки в toolbar
- Пиксель масштабируется, треугольник остаётся на месте

**Сценарий 5: Копировать результаты**
```
Пользователь → Кнопка Copy
                ↓
           result.__str__()  # форматирование
                ↓
           копировать в clipboard
                ↓
           Пользователь может вставить результаты куда угодно
```
- Формат: "V: X.XX м³, h: Y.YY м, R: Z.ZZ м"
- После копирования показывается уведомление

**Сценарий 6: Очистить треугольник**
```
Пользователь → Кнопка Clear / Edit → Clear Triangle
                ↓
           triangle.clear()
                ↓
           canvas_view.redraw()
                ↓
           info_panel.clear_results()
                ↓
           Готово к новому измерению
```
- Удаляет все точки треугольника
- Сохраняет текущее изображение
- Результаты очищаются

### Отсутствуют в MVP

❌ **Сохранение результатов в файл**
- Нет CSV/JSON экспорта
- Нет сохранения состояния приложения
- Всё хранится только в памяти текущего сеанса

❌ **История измерений**
- Нет списка предыдущих результатов
- Нет сравнения между измерениями

❌ **Работа с Trassir** (опционально)
- На этапе 1: только локальные файлы
- Trassir интеграция (видеопоток с камер) на этапе 2

❌ **Редактирование треугольника**
- Нельзя перемещать уже нарисованные точки
- Только очистить и нарисовать заново

### Обработка ошибок в сценариях

**При открытии файла:**
```python
try:
    image = image_loader.load_image(path)
    self.canvas_view.set_image(image)
except FileNotFoundError:
    messagebox.showerror("Error", "File not found")
    logger.error(f"File not found: {path}")
except Exception as e:
    messagebox.showerror("Error", f"Cannot load image: {e}")
    logger.error(f"Failed to load image: {e}")
```

**При расчётах:**
```python
try:
    result = cone_calculator.calculate(height_px, base_px, pixel_size)
except ValueError as e:
    logger.error(f"Calculation error: {e}")
    # Молча игнорируем, показываем старый результат
except Exception as e:
    logger.error(f"Unexpected error: {e}")
    messagebox.showerror("Error", f"Calculation failed: {e}")
```

### Ограничения сценариев

⚠️ **Размер изображения**
- Максимальный размер ограничен памятью и производительностью Tkinter
- Обычно до 4K без проблем

⚠️ **Размер треугольника**
- Минимальная высота/ширина > 0 пикселей
- Максимальная ширина = ширина изображения

⚠️ **Точность вычислений**
- Округление до 2 знаков после запятой
- В том числе вычисление расстояний (высота, радиус)

---

## 7. РАЗВЁРТЫВАНИЕ (DEPLOYMENT)

### Локальный запуск (разработка)

**Требования:**
- Python 3.13+
- Установленные зависимости (uv sync)

**Команда запуска:**
```bash
python main.py
```

### Сборка в exe (Windows)

**Требования:**
- auto-py-to-exe установлен (в pyproject.toml)

**Команда сборки:**
```bash
auto-py-to-exe --onedir --windowed --icon=resources/icon.ico main.py --add-data resources:resources
```

**Результат:**
- Папка `dist/` с исполняемым файлом `main.exe`
- Приложение можно раздавать пользователям
- Не требует Python на машине пользователя

### Поддерживаемые платформы

✅ **Windows** (тестируется)
- Python 3.13+ работает
- Tkinter встроена
- exe сборка работает


### Версионирование

**Текущая версия:** указана в `utils/constants.py`
```python
VERSION = "0.1.0"
```

**Обновление версии:**
- При добавлении функционала: 0.1.0 → 0.2.0
- При багов фиксах: 0.1.0 → 0.1.1
- Обновить в constants.py и pyproject.toml

### Минимальные требования для запуска

**На машине пользователя:**
- Windows 10+ / macOS 10.13+ / Ubuntu 18.04+
- (Для скомпилированного exe требуется только ОС)
- (Для python запуска требуется Python 3.13+)

**Интернет:**
- НЕ требуется для локальных файлов
- Требуется для Trassir (этап 2)

### CI/CD

❌ **В MVP нет**
- Нет автоматической сборки
- Нет тестирования на сервере
- Нет автоматического деплоя

✅ **Можно добавить на этапе 2**
- GitHub Actions для сборки exe
- Автоматический выпуск релизов

---

## 8. КОНФИГУРИРОВАНИЕ

### Единственный источник конфигурации

**Файл:** `utils/constants.py`

Все параметры приложения находятся в одном месте:

```python
# Версия и метаданные
VERSION = "0.1.0"
APP_NAME = "Cone App"
AUTHOR = "Артемий Семёнов"
WEBSITE = "https://semonoffart.github.io/"
GITHUB_URL = "https://github.com/SemonoffArt/cone"

# Размеры UI
CANVAS_WIDTH = 800
CANVAS_HEIGHT = 600
VERTEX_RADIUS = 6
LINE_WIDTH = 2

# Цвета
COLOR_TRIANGLE = "blue"
COLOR_VERTEX = "red"
COLOR_HOVER = "green"
COLOR_BG = "white"
COLOR_TEXT = "white"

# Шрифты
TEXT_FONT = ("Arial", 10)

# Масштабирование
DEFAULT_PIXEL_SIZE_M = 0.008  # размер пикселя в метрах

# Trassir (этап 2)
TRASSIR_ZIF1_IP = "10.100.59.10"
TRASSIR_ZIF2_IP = "10.100.72.14"
CAM_CONE_ZIF1 = {"chanel_name": "ЗИФ-1 19. Конус Руда", "trassir_ip": "10.100.59.10", "pixel_size_m": 0.08}
CAM_CONE_ZIF2 = {"chanel_name": "ККД-2 115. Конус", "trassir_ip": "10.100.72.14", "pixel_size_m": 0.16}

# Логирование
LOG_LEVEL = 'INFO'  # DEBUG, INFO, WARNING, ERROR, CRITICAL
```

### Как менять конфигурацию

1. **Размеры UI:** измените CANVAS_WIDTH, CANVAS_HEIGHT
2. **Цвета:** измените COLOR_* константы
3. **Масштаб по умолчанию:** измените DEFAULT_PIXEL_SIZE_M
4. **Логирование:** измените LOG_LEVEL
5. **Trassir:** обновите IP и названия каналов

❌ **НЕ создавайте конфиг файлы**
- В MVP всё в constants.py
- Простота > гибкость

✅ **Добавьте новую константу если:**
- Параметр используется в 2+ местах кода
- Его логично менять без изменения кода

### Переменные окружения

❌ **В MVP нет**
- Нет использования environ
- Все параметры в constants.py

✅ **Можно добавить на этапе 2**
- Если потребуется работать с разными конфигами (dev/prod)
- Для чувствительных данных (пароли, токены)

---

## 9. ЛОГИРОВАНИЕ

### Стратегия логирования

**Файл:** `utils/logger.py`

**Принцип:** Централизованное логирование, легко отследить ошибки

### Уровни логирования

| Уровень | Когда использовать | Пример |
|---------|-------------------|--------|
| DEBUG | Детальная информация для разработчика | `logger.debug(f"Triangle points: {points}")` |
| INFO | Важные события | `logger.info("Image loaded successfully")` |
| WARNING | Что-то подозрительное | `logger.warning("Image is very large")` |
| ERROR | Ошибка, но приложение продолжает работу | `logger.error(f"Failed to load: {e}")` |
| CRITICAL | Критическая ошибка | `logger.critical("Core calculation failed")` |

### Где логировать

**В core/**
```python
from utils.logger import app_logger

def calculate(height, base, pixel_size):
    app_logger.debug(f"Calculating: h={height}, b={base}, ps={pixel_size}")
    try:
        result = ...
        app_logger.info(f"Calculation successful: V={result.volume}")
        return result
    except Exception as e:
        app_logger.error(f"Calculation failed: {e}")
        raise
```

**В ui/**
```python
from utils.logger import app_logger

def on_open_file(self):
    app_logger.info("User opened file dialog")
    try:
        image = image_loader.load_image(path)
        app_logger.info(f"Image loaded: {path}")
    except Exception as e:
        app_logger.error(f"Failed to open file: {e}")
        messagebox.showerror("Error", f"Cannot open file: {e}")
```

### Вывод логов

**В разработке:**
- Логи выводятся в консоль
- LOG_LEVEL = 'DEBUG'

**При релизе:**
- Логи выводятся в консоль
- LOG_LEVEL = 'INFO'
- (Опционально) логи сохраняются в файл (добавить на этапе 2)

### Не логировать

❌ **Приватные данные**
- Пути до файлов (если они содержат username)
- Пароли, токены
- Чувствительные расчёты

❌ **Слишком детально**
- Каждое движение мыши
- Каждое изменение пикселя
- Слишком большие структуры данных

✅ **Логировать**
- Начало/конец важных операций
- Ошибки с описанием
- Запуск/остановка приложения
- Загрузку файлов, расчёты

---

### Макет файловой системы

```
cone/
├── core/                    # Бизнес-логика расчётов
│   ├── __init__.py
│   ├── cone_calculator.py   # Главный расчётчик объёма V = ⅓πR²h
│   ├── geometry.py          # Геометрические функции (расстояния, углы)
│   ├── triangle.py          # Работа с точками и координатами треугольника
│   └── image_loader.py      # Загрузка изображений (локальные файлы)
│
├── ui/                      # Пользовательский интерфейс (Tkinter)
│   ├── __init__.py
│   ├── main_window.py       # Главное окно + логика управления (контроллер)
│   ├── canvas_view.py       # Canvas для рисования треугольника и изображения
│   ├── info_panel.py        # Панель отображения результатов расчётов
│   ├── toolbar.py           # Кнопки управления (открыть, сохранить, масштаб)
│   └── menu.py              # Меню приложения (File, Help, About)
│
├── utils/                   # Вспомогательные функции
│   ├── __init__.py
│   ├── constants.py         # Единственный источник конфигурации
│   ├── logger.py            # Логирование приложения
│   └── trassir.py           # Интеграция с камерами Trassir (HTTP API)
│
├── resources/               # Статические ресурсы
│   └── icons/               # Иконки для UI (PNG)
│
├── doc/                     # Техническая документация
│   ├── idea.md              # Исходная идея проекта
│   └── vision.md            # Этот файл - техническое видение
│
├── main.py                  # Точка входа приложения
├── pyproject.toml           # Конфигурация зависимостей
├── uv.lock                  # Lock-файл зависимостей
└── README.md                # Пользовательская документация
```

### Назначение каждого компонента

**core/** - Независимая от UI логика
- `cone_calculator.py` - основной алгоритм расчёта объёма
- `geometry.py` - вспомогательные геометрические функции
- `triangle.py` - работа с координатами треугольника
- `image_loader.py` - чтение изображений с диска

**ui/** - Только отображение и взаимодействие
- `main_window.py` - главное окно, обработка событий, координирование компонентов
- `canvas_view.py` - отдельный класс для Tkinter Canvas (рисование и взаимодействие мышью)
- `info_panel.py` - панель с результатами (объём, высота, радиус)
- `toolbar.py` - кнопки для быстрого доступа
- `menu.py` - файловое меню, справка, о программе

**utils/** - Служебные функции
- `constants.py` - все параметры: размеры, цвета, IP-адреса, пути
- `logger.py` - логирование во время работы
- `trassir.py` - отдельный модуль для работы с Trassir API (загрузка видеопотока)

**resources/** - Статические данные
- Иконки для кнопок и меню

**doc/** - Техническая документация
- Архитектурные решения
- API компонентов
- Инструкции для разработчиков

### Зависимости между компонентами

```
main.py
  ↓
main_window.py (контроллер) 
  ├→ canvas_view.py (отображение)
  ├→ toolbar.py (кнопки)
  ├→ menu.py (меню)
  ├→ info_panel.py (результаты)
  │
  ├→ cone_calculator.py (расчёты)
  ├→ image_loader.py (загрузка изображений)
  │
  ├→ constants.py (параметры)
  ├→ logger.py (логирование)
  └→ trassir.py (интеграция с Trassir)
```

### Правила разделения

✅ **core/** НЕ импортирует из **ui/**
- core полностью независима, может использоваться без UI

✅ **ui/** импортирует из **core/**
- UI использует расчёты из core

✅ **Оба слоя** импортируют из **utils/**
- utils - общие функции и константы

❌ **Циклические зависимости** запрещены
- Только однонаправленный граф

---

## РЕЗЮМЕ ТЕХНИЧЕСКОГО ВИДЕНИЯ

### Цель

Валидировать идею минимальным МВП с самым необходимым функционалом.

### Ключевые характеристики

| Аспект | Решение |
|--------|----------|
| Кол-во зависимостей | Минимально (Пиллоу, Requests, auto-py-to-exe) |
| Архитектура | MVC - просто, без сложных паттернов |
| Конфигурация | Одна constants.py - всё видно |
| Состояние | Лишь в main_window, core — стателесс |
| Логирование | Централизованно в logger.py |
| Обработка ошибок | Try-except + логирование + сообщение юзеру |
| Персистенция | Нет (только память) |
| Экспорт | На этапе 2 |
| Trassir | Опционально на этапе 2 |

### Как начать разработку

1. **Установить зависимости**
   ```bash
   uv sync
   ```

2. **Открыть приложение**
   ```bash
   python main.py
   ```

3. **Начать разработку**
   - core/ — реализуйте расчёты
   - ui/ — модифицируйте интерфейс
   - utils/ — добавляйте конфигурацию

### Проверочный список MVP

- [ ] Открыть локальные изображения (PNG, JPG)
- [ ] Нарисовать триангл 3 кликами
- [ ] Автоматически рассчитать объём
- [ ] Показывать результаты (V, h, R)
- [ ] Масштабирование (+/-)
- [ ] Копирование на клипборд
- [ ] Очистка триангла
- [ ] Обработка ошибок
- [ ] Логирование всех операций

### Здравые деня

✅ МОЦНО:
- Прямые вызовы функций
- Короткие функции
- Чистые данные в структурах
- Одна constants.py
- Одна logger.py

❌ НЕ делайте:
- Абстрактные классы "на будущее"
- Глобальные состояния
- Паттерны Singleton, Factory, Observer
- Циклические зависимости
- Unit-тесты

---

**Дата составления:** 3 декабря 2025

**Версия MVP:** 0.1.0

**Готово к реализации!** ✅
